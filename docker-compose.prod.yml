# ============================================================
# MuCMS - Production Docker Compose Configuration
# ============================================================
# Production deployment with Redis cache and external MySQL

version: '3.8'

services:
  # ----------------------------------------------------------
  # Main Application (Express + Socket.io)
  # ----------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-/api}
        VITE_SOCKET_URL: ${VITE_SOCKET_URL:-/}
    image: mucms-app:${IMAGE_VERSION:-latest}
    container_name: mucms-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      # Database
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-3306}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-MuOnline}
      # Redis
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      # Admin
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      # Socket.io
      - SOCKET_IO_CORS_ORIGIN=${SOCKET_IO_CORS_ORIGIN:-*}
    volumes:
      # Persist uploads
      - uploads:/app/uploads
      # Logs
      - logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - mucms-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ----------------------------------------------------------
  # Redis Cache (Socket.io adapter + caching)
  # ----------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: mucms-redis
    restart: unless-stopped
    command: >
      sh -c '
        if [ -n "$REDIS_PASSWORD" ]; then
          redis-server --requirepass "$REDIS_PASSWORD" --maxmemory 256mb --maxmemory-policy allkeys-lru
        else
          redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
        fi
      '
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mucms-network
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ----------------------------------------------------------
  # Nginx Reverse Proxy (Optional, for SSL/load balancing)
  # ----------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: mucms-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - app
    networks:
      - mucms-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - with-nginx

# ----------------------------------------------------------
# Networks
# ----------------------------------------------------------
networks:
  mucms-network:
    driver: bridge
    name: mucms-network

# ----------------------------------------------------------
# Volumes
# ----------------------------------------------------------
volumes:
  uploads:
    name: mucms-uploads
    driver: local
  logs:
    name: mucms-logs
    driver: local
  redis-data:
    name: mucms-redis-data
    driver: local
